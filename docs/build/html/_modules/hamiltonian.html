
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>hamiltonian &#8212; Diatomic  documentation</title>
    
    <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
  
    
    <link rel="stylesheet"
      href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">
  
    
      
  
    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/pydata-sphinx-theme.css" />
    
    <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    
<a class="navbar-brand" href="../index.html">
<p class="title">Diatomic</p>
</a>

    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../instalation.html">
  Instalation
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../api_doc.html">
  API Reference
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <h1>Source code for hamiltonian</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">identify</span>

<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span> <span class="k">as</span> <span class="n">_sqrt</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">CubicSpline</span> <span class="k">as</span> <span class="n">_CubicSpline</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">splitext</span> <span class="k">as</span> <span class="n">_splitext</span>
<span class="kn">from</span> <span class="nn">interpolator</span> <span class="kn">import</span> <span class="n">CSpline</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">C_hartree</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Hamiltonian&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="Hamiltonian"><a class="viewcode-back" href="../hamiltonian.Hamiltonian.html#hamiltonian.Hamiltonian">[docs]</a><span class="k">class</span> <span class="nc">Hamiltonian</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Constructs the Hamiltonian operator, solves the time-independant coupled</span>
<span class="sd">    system of radial Shrodinger equations and builds a list of energy levels</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">diatomic_data</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">couplings</span><span class="o">=</span><span class="p">[],</span>
                 <span class="n">eig_decomp</span><span class="o">=</span><span class="s1">&#39;lapack&#39;</span><span class="p">,</span> <span class="n">lapack_driver</span><span class="o">=</span><span class="s1">&#39;evr&#39;</span><span class="p">,</span>
                 <span class="n">arpack_options</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;LM&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">is_weighted</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initilizes the Hamiltonian object</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            grid : Grid object</span>
<span class="sd">                The defined Grid object which has information about the grid</span>
<span class="sd">                parameters like number of grid points, the required range of</span>
<span class="sd">                internuclear distancies and the chosen solving method.</span>
<span class="sd">            diatomic_data : DiatomicData object</span>
<span class="sd">                The defined DiatomicData object which contains information</span>
<span class="sd">                about the specific molecule.</span>
<span class="sd">            channels : list</span>
<span class="sd">                Contains the list of the defined channel objects.</span>
<span class="sd">            couplings : list, optional</span>
<span class="sd">                Contains the list of the defined coupling objects.</span>
<span class="sd">                Defaults to [].</span>
<span class="sd">            eig_decomp : str, optional</span>
<span class="sd">                The package LAPACK or ARPACK which to be used for eigen</span>
<span class="sd">                decomposition. Defaults to &#39;lapack&#39;.</span>
<span class="sd">            lapack_driver : str, optional</span>
<span class="sd">                 Defines which LAPACK driver should be used when eig_decomp is</span>
<span class="sd">                 set to &quot;lapack&quot;. Valid options are &quot;ev&quot;, &quot;evd&quot;, &quot;evr&quot;, &quot;evx&quot;.</span>
<span class="sd">                 Defaults to &#39;evr&#39;.</span>
<span class="sd">            arpack_options : tuple, optional</span>
<span class="sd">                [description]. Defaults to (&#39;LM&#39;, 6, None).</span>
<span class="sd">            is_weighted : bool, optional</span>
<span class="sd">                [description]. Defaults to False.</span>

<span class="sd">        Notes</span>
<span class="sd">        ----------</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">ngrid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rmin</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">rmin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rmax</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">rmax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rgrid</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">rgrid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rgrid2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rgrid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rstep</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">rstep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">solver</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">molecule</span> <span class="o">=</span> <span class="n">diatomic_data</span><span class="o">.</span><span class="n">molecule</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mol_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">isdigit</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecule</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jqnumbers</span> <span class="o">=</span> <span class="n">diatomic_data</span><span class="o">.</span><span class="n">jqnumbers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">diatomic_data</span><span class="o">.</span><span class="n">symmetry</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masses</span> <span class="o">=</span> <span class="n">diatomic_data</span><span class="o">.</span><span class="n">reduced_masses</span> <span class="ow">or</span> <span class="n">diatomic_data</span><span class="o">.</span><span class="n">masses</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">niso</span> <span class="o">=</span> <span class="n">diatomic_data</span><span class="o">.</span><span class="n">niso</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refj</span> <span class="o">=</span> <span class="n">diatomic_data</span><span class="o">.</span><span class="n">refj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refE</span> <span class="o">=</span> <span class="n">diatomic_data</span><span class="o">.</span><span class="n">refE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span> <span class="o">=</span> <span class="n">diatomic_data</span><span class="o">.</span><span class="n">exp_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exp_file</span> <span class="o">=</span> <span class="n">diatomic_data</span><span class="o">.</span><span class="n">exp_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wavens_data</span> <span class="o">=</span> <span class="n">diatomic_data</span><span class="o">.</span><span class="n">wavens_data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">channels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">couplings</span> <span class="o">=</span> <span class="n">couplings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nch</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">couplings</span><span class="p">)</span>

        <span class="c1"># energy ranges when extracting term values</span>
        <span class="c1"># self.uenergy_range = None</span>
        <span class="c1"># self.lenergy_range = None</span>

        <span class="c1"># mapping arrays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Fy</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">Fy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Gy</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">Gy</span>

        <span class="c1"># determine matrix size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nch</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span>

        <span class="c1"># store diagonal indices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">)</span>

        <span class="c1"># which module to be used for eigen decomposition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eig_decomp</span> <span class="o">=</span> <span class="n">eig_decomp</span>

        <span class="c1"># the lapack procedure syevr() is used by default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lapack_driver</span> <span class="o">=</span> <span class="n">lapack_driver</span>

        <span class="c1"># which eigenvalues to use in the arpack procedure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arpack_which</span> <span class="o">=</span> <span class="n">arpack_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># in the arpack procedure k=6 by default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arpack_k</span> <span class="o">=</span> <span class="n">arpack_options</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># if sigma is set shift-invert mode is requested</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arpack_sigma</span> <span class="o">=</span> <span class="n">arpack_options</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># map the diagonalization procedures</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diagonilize</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;lapack&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lapack_eig_decomposition</span><span class="p">,</span>
            <span class="s1">&#39;arpack&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arpack_eig_decomposition</span>
        <span class="p">}</span>

        <span class="c1"># Watson&#39;s weighting method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_weighted</span> <span class="o">=</span> <span class="n">is_weighted</span>

        <span class="c1"># max number of fit parameters</span>
        <span class="n">nmax_params</span> <span class="o">=</span> <span class="mi">200</span>

        <span class="c1"># max number of computed levels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmax_levels</span> <span class="o">=</span> <span class="mi">10000</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kin_enr</span> <span class="o">=</span> <span class="n">KineticEnergy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pot_enr</span> <span class="o">=</span> <span class="n">PotentialEnergy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interact</span> <span class="o">=</span> <span class="n">Interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># matrix with the spline S functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sk_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">msize</span><span class="p">,</span> <span class="n">nmax_params</span><span class="p">))</span>

        <span class="c1"># used in the fit for initilization of the parameters</span>
        <span class="n">channel_pars</span> <span class="o">=</span> <span class="n">diatomic_data</span><span class="o">.</span><span class="n">get_channel_parameters</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
        <span class="n">coupling_pars</span> <span class="o">=</span> <span class="n">diatomic_data</span><span class="o">.</span><span class="n">get_coupling_parameters</span><span class="p">(</span><span class="n">couplings</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ypar_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">channel_pars</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coupling_pars</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yfixed_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">channel_pars</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">coupling_pars</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="c1"># get other parameters and functions used in the fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unq_channel_inds</span> <span class="o">=</span> <span class="n">diatomic_data</span><span class="o">.</span><span class="n">unq_chind</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edit_channel_parameters</span> <span class="o">=</span> <span class="n">diatomic_data</span><span class="o">.</span><span class="n">edit_channel_parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edit_coupling_parameters</span> <span class="o">=</span> <span class="n">diatomic_data</span><span class="o">.</span><span class="n">edit_coupling_parameters</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_functions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ypar_init</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">file_energies</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;energies_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mol_name</span><span class="si">}</span><span class="s1">.dat&#39;</span>

<div class="viewcode-block" id="Hamiltonian.interpolate_functions"><a class="viewcode-back" href="../hamiltonian.Hamiltonian.html#hamiltonian.Hamiltonian.interpolate_functions">[docs]</a>    <span class="k">def</span> <span class="nf">interpolate_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ypar</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Interpolates coupling and channel functions on the grid of points</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            ypar : numpy.ndarray</span>
<span class="sd">                An array containing the corresponding parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pot_enr</span><span class="o">.</span><span class="n">calculate_channels_on_grid</span><span class="p">(</span><span class="n">ypar</span><span class="o">=</span><span class="n">ypar</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ugrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pot_enr</span><span class="o">.</span><span class="n">ugrid</span>

        <span class="c1"># self.fgrid = np.zeros(self.ncp * self.ngrid)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interact</span><span class="o">.</span><span class="n">calculate_couplings_on_grid</span><span class="p">(</span><span class="n">ypar</span><span class="o">=</span><span class="n">ypar</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fgrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interact</span><span class="o">.</span><span class="n">fgrid</span></div>

<div class="viewcode-block" id="Hamiltonian.get_energy_levels"><a class="viewcode-back" href="../hamiltonian.Hamiltonian.html#hamiltonian.Hamiltonian.get_energy_levels">[docs]</a>    <span class="k">def</span> <span class="nf">get_energy_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ident_option</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">store_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">out_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ident_option</span> <span class="o">=</span> <span class="n">ident_option</span> <span class="k">if</span> <span class="n">ident_option</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out_data</span> <span class="o">=</span> <span class="n">identify</span><span class="o">.</span><span class="n">identify_levels</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calc_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nch</span><span class="p">,</span> <span class="n">ident_option</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">store_output</span><span class="p">:</span>
                <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_stats</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">out_data</span><span class="p">[:,</span> <span class="mi">8</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_data</span><span class="p">[:,</span> <span class="mi">7</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">out_data</span><span class="p">[:,</span> <span class="mi">10</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_weighted</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">energy_out_file</span> <span class="o">=</span> <span class="n">out_file</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_energies</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_predicted_energies</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_data</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_output_data</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Experimental energy terms should be provided.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_data</span></div>

<div class="viewcode-block" id="Hamiltonian.solve"><a class="viewcode-back" href="../hamiltonian.Hamiltonian.html#hamiltonian.Hamiltonian.solve">[docs]</a>    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energy_subset_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">energy_subset_value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">energy_subset_value</span> <span class="o">=</span> <span class="n">energy_subset_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy_subset_index</span> <span class="o">=</span> <span class="n">energy_subset_index</span>

        <span class="c1"># count the total number of eigenvalues</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ecount</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">evalues_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nmax_levels</span><span class="p">,</span> <span class="mi">9</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">nch</span><span class="p">))</span>
        <span class="n">evecs_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">msize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmax_levels</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">niso</span><span class="p">,</span> <span class="n">iso</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">niso</span><span class="p">):</span>
            <span class="n">tmatrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kin_enr</span><span class="o">.</span><span class="n">calculate_kinetic_energy</span><span class="p">(</span><span class="n">iso</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">:</span>
                <span class="n">shiftE</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>  <span class="c1"># pass by reference; make it self?</span>
                <span class="k">for</span> <span class="n">jrotn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jqnumbers</span><span class="p">:</span>

                    <span class="c1"># build and diagonalize the hamiltonian matrix</span>
                    <span class="n">hmatrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_hamiltonian</span><span class="p">(</span><span class="n">iso</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">jrotn</span><span class="p">,</span> <span class="n">tmatrix</span><span class="p">)</span>
                    <span class="n">evalues</span><span class="p">,</span> <span class="n">evecs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagonilize</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">eig_decomp</span><span class="p">](</span><span class="n">hmatrix</span><span class="p">)</span>

                    <span class="c1"># arange and store quantum numbers and labels for levels</span>
                    <span class="n">nevalues</span> <span class="o">=</span> <span class="n">evalues</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">levels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arange_levels</span><span class="p">(</span>
                        <span class="n">jrotn</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">iso</span><span class="p">,</span> <span class="n">evalues</span><span class="p">,</span> <span class="n">evecs</span><span class="p">,</span> <span class="n">shiftE</span><span class="o">=</span><span class="n">shiftE</span><span class="p">)</span>
                    <span class="n">evalues_all</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ecount</span><span class="p">:</span><span class="n">nevalues</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">ecount</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">levels</span>
                    <span class="n">evecs_all</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecount</span><span class="p">:</span><span class="n">nevalues</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">ecount</span><span class="p">]</span> <span class="o">=</span> <span class="n">evecs</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ecount</span> <span class="o">+=</span> <span class="n">nevalues</span>

        <span class="n">evalues_all</span> <span class="o">=</span> <span class="n">evalues_all</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">ecount</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">evecs_all</span> <span class="o">=</span> <span class="n">evecs_all</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">ecount</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_matrix</span> <span class="o">=</span> <span class="n">hmatrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">evecs_matrix</span> <span class="o">=</span> <span class="n">evalues_all</span><span class="p">,</span> <span class="n">evecs_all</span>

        <span class="k">return</span> <span class="n">evalues_all</span><span class="p">,</span> <span class="n">evecs_all</span></div>

<div class="viewcode-block" id="Hamiltonian.wrapper_calculate_diatomic_levels"><a class="viewcode-back" href="../hamiltonian.Hamiltonian.html#hamiltonian.Hamiltonian.wrapper_calculate_diatomic_levels">[docs]</a>    <span class="k">def</span> <span class="nf">wrapper_calculate_diatomic_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ypar</span><span class="p">):</span>

        <span class="c1"># call this function trough the fitting routine</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_functions</span><span class="p">(</span><span class="n">ypar</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">energy_subset_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">energy_subset_index</span><span class="p">,</span>
                   <span class="n">energy_subset_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">energy_subset_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_energy_levels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ident_option</span><span class="p">,</span> <span class="n">store_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="Hamiltonian.extract_terms_in_range"><a class="viewcode-back" href="../hamiltonian.Hamiltonian.html#hamiltonian.Hamiltonian.extract_terms_in_range">[docs]</a>    <span class="k">def</span> <span class="nf">extract_terms_in_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uenergy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lenergy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">usymm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lsymm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">uj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ustate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lstate</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># TODO: it may happen that the number of levels within these</span>
        <span class="c1"># ranges will vary during the fit</span>

        <span class="n">eind</span><span class="p">,</span> <span class="n">jind</span><span class="p">,</span> <span class="n">pind</span><span class="p">,</span> <span class="n">sind</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span>

        <span class="c1"># filter by energy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uenergy</span> <span class="o">=</span> <span class="n">uenergy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lenergy</span> <span class="o">=</span> <span class="n">lenergy</span>
        <span class="n">calc_uterms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_data</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_data</span><span class="p">[:,</span> <span class="n">eind</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uenergy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span>
                                     <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_data</span><span class="p">[:,</span> <span class="n">eind</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uenergy</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="n">calc_lterms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_data</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_data</span><span class="p">[:,</span> <span class="n">eind</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lenergy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span>
                                     <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_data</span><span class="p">[:,</span> <span class="n">eind</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lenergy</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

        <span class="c1"># filter by J</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uj</span> <span class="o">=</span> <span class="n">uj</span> <span class="ow">or</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">calc_uterms</span><span class="p">[:,</span> <span class="n">jind</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">calc_uterms</span><span class="p">[:,</span> <span class="n">jind</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lj</span> <span class="o">=</span> <span class="n">lj</span> <span class="ow">or</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">calc_lterms</span><span class="p">[:,</span> <span class="n">jind</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">calc_lterms</span><span class="p">[:,</span> <span class="n">jind</span><span class="p">]))</span>
        <span class="n">calc_uterms</span> <span class="o">=</span> <span class="n">calc_uterms</span><span class="p">[(</span><span class="n">calc_uterms</span><span class="p">[:,</span> <span class="n">jind</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uj</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span>
                                  <span class="p">(</span><span class="n">calc_uterms</span><span class="p">[:,</span> <span class="n">jind</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uj</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="n">calc_lterms</span> <span class="o">=</span> <span class="n">calc_lterms</span><span class="p">[(</span><span class="n">calc_lterms</span><span class="p">[:,</span> <span class="n">jind</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lj</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span>
                                  <span class="p">(</span><span class="n">calc_lterms</span><span class="p">[:,</span> <span class="n">jind</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lj</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

        <span class="c1"># filter by symmetry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">usymm</span> <span class="o">=</span> <span class="n">usymm</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lsymm</span> <span class="o">=</span> <span class="n">lsymm</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">calc_uterms</span> <span class="o">=</span> <span class="n">calc_uterms</span><span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">calc_uterms</span><span class="p">[:,</span> <span class="n">pind</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">usymm</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">|</span>
                                  <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">calc_uterms</span><span class="p">[:,</span> <span class="n">pind</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">usymm</span><span class="p">[</span><span class="mi">1</span><span class="p">]))]</span>
        <span class="n">calc_lterms</span> <span class="o">=</span> <span class="n">calc_lterms</span><span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">calc_lterms</span><span class="p">[:,</span> <span class="n">pind</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lsymm</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">|</span>
                                  <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">calc_lterms</span><span class="p">[:,</span> <span class="n">pind</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lsymm</span><span class="p">[</span><span class="mi">1</span><span class="p">]))]</span>

        <span class="c1"># filter by state - use only for single states</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ustate</span> <span class="o">=</span> <span class="n">ustate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lstate</span> <span class="o">=</span> <span class="n">lstate</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ustate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">calc_uterms</span> <span class="o">=</span> <span class="n">calc_uterms</span><span class="p">[</span><span class="n">calc_uterms</span><span class="p">[:,</span> <span class="n">sind</span><span class="p">]</span> <span class="o">==</span> <span class="n">ustate</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">calc_lterms</span> <span class="o">=</span> <span class="n">calc_lterms</span><span class="p">[</span><span class="n">calc_lterms</span><span class="p">[:,</span> <span class="n">sind</span><span class="p">]</span> <span class="o">==</span> <span class="n">lstate</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">calc_uterms</span><span class="p">,</span> <span class="n">calc_lterms</span></div>

<div class="viewcode-block" id="Hamiltonian.build_hamiltonian"><a class="viewcode-back" href="../hamiltonian.Hamiltonian.html#hamiltonian.Hamiltonian.build_hamiltonian">[docs]</a>    <span class="k">def</span> <span class="nf">build_hamiltonian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iso</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">jrotn</span><span class="p">,</span> <span class="n">tmatrix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Builds the Hamiltonian matrix by summing the block diagonal matrix</span>
<span class="sd">        of the kinetic energy, the diagonal matrix of potential energy</span>
<span class="sd">        and the coupling matrix with diagonal and off-diagonal blocks</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            iso : bool0</span>
<span class="sd">                Isotopologue number</span>
<span class="sd">            par : int</span>
<span class="sd">                Symmetry label</span>
<span class="sd">            jrotn : float</span>
<span class="sd">                The rotational quantum number</span>
<span class="sd">            tmatrix : numpy.ndarray</span>
<span class="sd">                The kinetic energy matrix</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">            hmatrix : numpy.ndarray</span>
<span class="sd">                The Hamiltonian matrix</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">vmatrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pot_enr</span><span class="o">.</span><span class="n">calculate_potential_energy</span><span class="p">(</span><span class="n">jrotn</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">iso</span><span class="p">)</span>
        <span class="n">imatrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interact</span><span class="o">.</span><span class="n">calculate_coupling_matrix</span><span class="p">(</span><span class="n">jrotn</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">iso</span><span class="p">)</span>
        <span class="n">hmatrix</span> <span class="o">=</span> <span class="n">tmatrix</span> <span class="o">+</span> <span class="n">vmatrix</span> <span class="o">+</span> <span class="n">imatrix</span>
        <span class="c1"># evalues, evecs = self.diagonilize[self.eig_decomp](hmatrix)</span>

        <span class="k">return</span> <span class="n">hmatrix</span></div>

<div class="viewcode-block" id="Hamiltonian._lapack_eig_decomposition"><a class="viewcode-back" href="../hamiltonian.Hamiltonian.html#hamiltonian.Hamiltonian._lapack_eig_decomposition">[docs]</a>    <span class="k">def</span> <span class="nf">_lapack_eig_decomposition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hmatrix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Diagonilizes the Hamiltonian matrix with the scipy &quot;eigh&quot; procedure</span>
<span class="sd">        from the LAPACK package</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            hmatrix : numpy.ndarray</span>
<span class="sd">                The Hamiltonian matrix</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">            evalues : numpy.ndarray</span>
<span class="sd">                The computed eigenvalues</span>
<span class="sd">            evecs : numpy.ndarray</span>
<span class="sd">                The computed eigenvectors</span>

<span class="sd">        Notes</span>
<span class="sd">        ----------</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">subset_value</span><span class="p">,</span> <span class="n">subset_index</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_subset_index</span><span class="p">:</span>
            <span class="n">emini</span><span class="p">,</span> <span class="n">emaxi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_subset_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">emaxi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_subset_index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">subset_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">emini</span><span class="p">,</span> <span class="n">emaxi</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_subset_value</span><span class="p">:</span>
            <span class="n">eminv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_subset_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">C_hartree</span>
            <span class="n">emaxv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_subset_value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">C_hartree</span>
            <span class="n">subset_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">eminv</span><span class="p">,</span> <span class="n">emaxv</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">subset_value</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>

        <span class="n">evalues</span><span class="p">,</span> <span class="n">evecs</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span>
            <span class="n">hmatrix</span><span class="p">,</span>
            <span class="n">eigvals_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">overwrite_a</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">lower</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">subset_by_index</span><span class="o">=</span><span class="n">subset_index</span><span class="p">,</span>
            <span class="n">subset_by_value</span><span class="o">=</span><span class="n">subset_value</span><span class="p">,</span>
            <span class="n">driver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lapack_driver</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
            <span class="n">check_finite</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">evalues</span><span class="p">,</span> <span class="n">evecs</span></div>

<div class="viewcode-block" id="Hamiltonian.eigsh"><a class="viewcode-back" href="../hamiltonian.Hamiltonian.html#hamiltonian.Hamiltonian.eigsh">[docs]</a>    <span class="k">def</span> <span class="nf">eigsh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Hamiltonian.eigh"><a class="viewcode-back" href="../hamiltonian.Hamiltonian.html#hamiltonian.Hamiltonian.eigh">[docs]</a>    <span class="k">def</span> <span class="nf">eigh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Hamiltonian._arpack_eig_decomposition"><a class="viewcode-back" href="../hamiltonian.Hamiltonian.html#hamiltonian.Hamiltonian._arpack_eig_decomposition">[docs]</a>    <span class="k">def</span> <span class="nf">_arpack_eig_decomposition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hmatrix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Diagonilizes the Hamiltonian matrix with the scipy sparse eigsh() procedure</span>
<span class="sd">        from the ARPACK package</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            hmatrix : numpy.ndarray</span>
<span class="sd">                The Hamiltonian matrix</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">            evalues : numpy.ndarray</span>
<span class="sd">                The coumputed eiegenvalues</span>
<span class="sd">            evecs : numpy.ndarray</span>
<span class="sd">                The computed eigenvectors</span>

<span class="sd">        Notes</span>
<span class="sd">        ----------</span>
<span class="sd">            ARAPCK procedure is the most efficient and suitable for finding</span>
<span class="sd">            the largest eigenvalues of a sparse matrix. If the smallest</span>
<span class="sd">            eigenvalues are desired then it is recommended to use a</span>
<span class="sd">            shift-invert mode. It transforms the eigenvalue problem to</span>
<span class="sd">            an eqivalent problem with shifted eigenvalues in which the</span>
<span class="sd">            small eigenvalues u become the large eigenvalues v: v = 1 / u</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">evalues</span><span class="p">,</span> <span class="n">evecs</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigsh</span><span class="p">(</span>
            <span class="n">hmatrix</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">arpack_k</span><span class="p">,</span>
            <span class="n">which</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">arpack_which</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
            <span class="n">sigma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">arpack_sigma</span><span class="p">,</span>
            <span class="n">return_eigenvectors</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">evalues</span><span class="p">,</span> <span class="n">evecs</span></div>

<div class="viewcode-block" id="Hamiltonian.arange_levels"><a class="viewcode-back" href="../hamiltonian.Hamiltonian.html#hamiltonian.Hamiltonian.arange_levels">[docs]</a>    <span class="k">def</span> <span class="nf">arange_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jrotn</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">iso</span><span class="p">,</span> <span class="n">evalues</span><span class="p">,</span> <span class="n">evecs</span><span class="p">,</span> <span class="n">shiftE</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">]):</span>
        <span class="c1"># nevalues = evalues.shape[0]</span>
        <span class="c1"># levels = self._arange_levels(</span>
        <span class="c1">#   jrotn, par, iso, evalues, evecs, shiftE=shiftE)</span>
        <span class="c1"># self.calc_data[self.ecount:nevalues+self.ecount, :] = levels</span>
        <span class="c1"># self.evecs_matrix[:, self.ecount:nevalues+self.ecount] = evecs</span>
        <span class="c1"># self.ecount += nevalues</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Hamiltonian._arange_levels"><a class="viewcode-back" href="../hamiltonian.Hamiltonian.html#hamiltonian.Hamiltonian._arange_levels">[docs]</a>    <span class="k">def</span> <span class="nf">_arange_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jrotn</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">iso</span><span class="p">,</span> <span class="n">evalues</span><span class="p">,</span> <span class="n">evecs</span><span class="p">,</span> <span class="n">shiftE</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Given the good quantum numbers, labels and the computed eigenvalues this</span>
<span class="sd">        function will find and compute additional quantum numbers and labels</span>
<span class="sd">        and will arange the full information for each level in one matrix</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            jrotn : float</span>
<span class="sd">                The rotational quantum number</span>
<span class="sd">            par : int</span>
<span class="sd">                Symmetry label, 0 for f- and 1 for e-symmetry</span>
<span class="sd">            iso : int</span>
<span class="sd">                The isotopolgue number</span>
<span class="sd">            evalues : numpy.ndarray</span>
<span class="sd">                The array with the computed eigenvalues</span>
<span class="sd">            evecs : numpy.ndarray</span>
<span class="sd">                The array with the computed eigenvectors</span>
<span class="sd">            shiftE : list, optional</span>
<span class="sd">                The value of the energy to shift the levels. Defaults to [0.0].</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">            levels : numpy.ndarray</span>
<span class="sd">                An array containing all levels i.e. energy, quantum numbers</span>
<span class="sd">                and labels</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecount</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">evalues</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">ecount</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refj</span> <span class="ow">and</span> <span class="n">jrotn</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">jqnumbers</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">shiftE</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">evalues</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">refE</span><span class="p">:</span>
            <span class="n">shiftE</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refE</span>

        <span class="n">evalues_shifted</span> <span class="o">=</span> <span class="p">(</span><span class="n">evalues</span> <span class="o">-</span> <span class="n">shiftE</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">C_hartree</span>

        <span class="n">ccoefs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_coupling_coefficients</span><span class="p">(</span><span class="n">evecs</span><span class="p">)</span>
        <span class="n">states</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">ccoefs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">vibnums</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_vibrational_number</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
        <span class="n">lambdas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lambda_values</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
        <span class="n">omegas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_omega_values</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>

        <span class="n">levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span>
                <span class="n">ids</span><span class="p">,</span> <span class="n">evalues_shifted</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">evalues_shifted</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span> <span class="n">jrotn</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">evalues_shifted</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span> <span class="n">par</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">evalues_shifted</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span> <span class="n">iso</span><span class="p">),</span>
                <span class="n">ccoefs</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">vibnums</span><span class="p">,</span> <span class="n">lambdas</span><span class="p">,</span> <span class="n">omegas</span>
        <span class="p">))</span>

        <span class="k">return</span> <span class="n">levels</span></div>

<div class="viewcode-block" id="Hamiltonian._get_coupling_coefficients"><a class="viewcode-back" href="../hamiltonian.Hamiltonian.html#hamiltonian.Hamiltonian._get_coupling_coefficients">[docs]</a>    <span class="k">def</span> <span class="nf">_get_coupling_coefficients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evecs</span><span class="p">):</span>

        <span class="c1"># assign state based on the largest coupling coefficient</span>
        <span class="n">ccoefs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">evecs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nch</span><span class="p">))</span>
        <span class="n">evecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">evecs</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nch</span><span class="p">):</span>
            <span class="n">ccoefs</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">evecs</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">:(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ccoefs</span></div>

<div class="viewcode-block" id="Hamiltonian._assign_vibrational_number"><a class="viewcode-back" href="../hamiltonian.Hamiltonian.html#hamiltonian.Hamiltonian._assign_vibrational_number">[docs]</a>    <span class="k">def</span> <span class="nf">_assign_vibrational_number</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">):</span>

        <span class="n">vibns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">vibns_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nch</span><span class="p">)</span>
        <span class="n">vibns_count</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">states</span><span class="p">):</span>
            <span class="n">vibns_count</span><span class="p">[</span><span class="n">state</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">vibns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vibns_count</span><span class="p">[</span><span class="n">state</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">vibns</span></div>

<div class="viewcode-block" id="Hamiltonian._get_lambda_values"><a class="viewcode-back" href="../hamiltonian.Hamiltonian.html#hamiltonian.Hamiltonian._get_lambda_values">[docs]</a>    <span class="k">def</span> <span class="nf">_get_lambda_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">nlambda</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">states</span><span class="p">)),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Hamiltonian._get_omega_values"><a class="viewcode-back" href="../hamiltonian.Hamiltonian.html#hamiltonian.Hamiltonian._get_omega_values">[docs]</a>    <span class="k">def</span> <span class="nf">_get_omega_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">omega</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">states</span><span class="p">)),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Hamiltonian.calculate_stats"><a class="viewcode-back" href="../hamiltonian.Hamiltonian.html#hamiltonian.Hamiltonian.calculate_stats">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yobs</span><span class="p">,</span> <span class="n">ycal</span><span class="p">,</span> <span class="n">yunc</span><span class="p">,</span> <span class="n">is_weighted</span><span class="p">):</span>

        <span class="n">diff_square</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">yobs</span> <span class="o">-</span> <span class="n">ycal</span><span class="p">)</span>

        <span class="c1"># calculate chi square</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_weighted</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">yunc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">yunc</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.33</span> <span class="o">*</span> <span class="p">(</span><span class="n">diff_square</span><span class="p">))</span>

        <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">diff_square</span> <span class="o">*</span> <span class="n">weights</span><span class="p">)</span> <span class="o">/</span> <span class="n">yobs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># calculate rms</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">diff_square</span><span class="p">)</span> <span class="o">/</span> <span class="n">yobs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">rms</span> <span class="o">=</span> <span class="n">_sqrt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="c1"># calculate dimensionless rms</span>
        <span class="n">rmsd</span> <span class="o">=</span> <span class="n">_sqrt</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">rms</span><span class="p">,</span> <span class="n">rmsd</span></div>

<div class="viewcode-block" id="Hamiltonian.save_output_data"><a class="viewcode-back" href="../hamiltonian.Hamiltonian.html#hamiltonian.Hamiltonian.save_output_data">[docs]</a>    <span class="k">def</span> <span class="nf">save_output_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stats</span><span class="p">):</span>

        <span class="c1"># add numbering</span>
        <span class="n">outdata_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">out_data</span><span class="p">]</span>

        <span class="n">coef</span> <span class="o">=</span> <span class="s1">&#39;coef&#39;</span>
        <span class="n">coef_labels</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">coef</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">:</span><span class="s1">^8</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nch</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;J&#39;</span><span class="p">,</span> <span class="s1">&#39;omega&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="s1">&#39;lambda&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;symmetry&#39;</span><span class="p">,</span> <span class="s1">&#39;marker&#39;</span><span class="p">,</span> <span class="s1">&#39;Ecalc&#39;</span><span class="p">,</span> <span class="s1">&#39;Eexp&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;delta&#39;</span><span class="p">,</span> <span class="s1">&#39;unc&#39;</span><span class="p">,</span> <span class="n">coef_labels</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">)</span>

        <span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">^11</span><span class="si">}{</span><span class="n">labels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">&lt;7</span><span class="si">}{</span><span class="n">labels</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s1">&lt;6</span><span class="si">}{</span><span class="n">labels</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">:</span><span class="s1">&lt;8</span><span class="si">}</span><span class="s1">&#39;</span>
                  <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="si">:</span><span class="s1">&lt;6</span><span class="si">}{</span><span class="n">labels</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="si">:</span><span class="s1">&lt;7</span><span class="si">}{</span><span class="n">labels</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="si">:</span><span class="s1">&lt;9</span><span class="si">}{</span><span class="n">labels</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="si">:</span><span class="s1">&lt;10</span><span class="si">}</span><span class="s1">&#39;</span>
                  <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="si">:</span><span class="s1">&lt;14</span><span class="si">}{</span><span class="n">labels</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="si">:</span><span class="s1">&lt;15</span><span class="si">}{</span><span class="n">labels</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="si">:</span><span class="s1">&lt;12</span><span class="si">}</span><span class="s1">&#39;</span>
                  <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="si">:</span><span class="s1">&lt;7</span><span class="si">}{</span><span class="n">labels</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="si">:</span><span class="s1">&gt;15</span><span class="si">}{</span><span class="n">labels</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">fmt</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%7d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%5d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%7.1f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%7.1f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%7.1f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%5d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%6d</span><span class="s1">&#39;</span><span class="p">,</span>
               <span class="s1">&#39;</span><span class="si">%6d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%15.6f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%14.6f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%12.6f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%9.4f</span><span class="s1">&#39;</span><span class="p">]</span>
        <span class="n">fmt</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nch</span><span class="o">*</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%7.3f</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%5d</span><span class="s1">&#39;</span><span class="p">]</span>

        <span class="n">footer</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Chi Square = </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.8f</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
                  <span class="sa">f</span><span class="s1">&#39;RMS = </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.8f</span><span class="si">}</span><span class="s1"> cm-1</span><span class="se">\n</span><span class="s1">&#39;</span>
                  <span class="sa">f</span><span class="s1">&#39;RMSD = </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s1">.8f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy_out_file</span><span class="p">,</span> <span class="n">outdata_num</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span>
                   <span class="n">footer</span><span class="o">=</span><span class="n">footer</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="p">)</span></div>

<div class="viewcode-block" id="Hamiltonian.save_predicted_energies"><a class="viewcode-back" href="../hamiltonian.Hamiltonian.html#hamiltonian.Hamiltonian.save_predicted_energies">[docs]</a>    <span class="k">def</span> <span class="nf">save_predicted_energies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">calc_energies</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stores the complete list of computed energy levels in external file</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">nrows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nrows</span><span class="o">-</span><span class="mi">3</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># calc_data_out = self.calc_data[:, cols]</span>
        <span class="n">calc_energies_out</span> <span class="o">=</span> <span class="n">calc_energies</span><span class="p">[:,</span> <span class="n">cols</span><span class="p">]</span>

        <span class="n">coef</span> <span class="o">=</span> <span class="s1">&#39;coef&#39;</span>
        <span class="n">coef_labels</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">coef</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">:</span><span class="s1">^10</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nch</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;Ecalc&#39;</span><span class="p">,</span> <span class="s1">&#39;J&#39;</span><span class="p">,</span> <span class="s1">&#39;symmetry&#39;</span><span class="p">,</span> <span class="s1">&#39; marker&#39;</span><span class="p">,</span>
                  <span class="n">coef_labels</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="s1">&#39;lambda&#39;</span><span class="p">,</span> <span class="s1">&#39;omega&#39;</span><span class="p">)</span>

        <span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">^10</span><span class="si">}{</span><span class="n">labels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">&lt;9</span><span class="si">}{</span><span class="n">labels</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s1">&lt;15</span><span class="si">}{</span><span class="n">labels</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">:</span><span class="s1">&lt;4</span><span class="si">}</span><span class="s1">&#39;</span>
                  <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="si">:</span><span class="s1">&lt;7</span><span class="si">}{</span><span class="n">labels</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="si">:</span><span class="s1">&lt;7</span><span class="si">}{</span><span class="n">labels</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="si">}{</span><span class="n">labels</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="si">:</span><span class="s1">&lt;7</span><span class="si">}</span><span class="s1">&#39;</span>
                  <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="si">:</span><span class="s1">&lt;9</span><span class="si">}{</span><span class="n">labels</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">fmt</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%7.1d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%5.1d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%16.6f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%7.1f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%5.1d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%7.1d</span><span class="s1">&#39;</span><span class="p">]</span>
        <span class="n">fmt</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nch</span><span class="o">*</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%9.3f</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%6.1d</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%8.1f</span><span class="s1">&#39;</span><span class="p">]</span>

        <span class="n">fname_def</span><span class="p">,</span> <span class="n">fext_def</span> <span class="o">=</span> <span class="n">_splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_energies</span><span class="p">)</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="n">fname_def</span> <span class="o">+</span> <span class="s1">&#39;_predicted&#39;</span> <span class="o">+</span> <span class="n">fext_def</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="n">filename</span> <span class="ow">or</span> <span class="n">output_file</span>

        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">calc_energies_out</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="p">)</span></div>

<div class="viewcode-block" id="Hamiltonian._sort_predicted_energies"><a class="viewcode-back" href="../hamiltonian.Hamiltonian.html#hamiltonian.Hamiltonian._sort_predicted_energies">[docs]</a>    <span class="k">def</span> <span class="nf">_sort_predicted_energies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="p">[]):</span>

        <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_data</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">cols</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">lexsort</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">out</span><span class="p">))]</span></div>

<div class="viewcode-block" id="Hamiltonian.sort_predicted_energies"><a class="viewcode-back" href="../hamiltonian.Hamiltonian.html#hamiltonian.Hamiltonian.sort_predicted_energies">[docs]</a>    <span class="k">def</span> <span class="nf">sort_predicted_energies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="p">[]):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sort_predicted_energies</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_predicted_energies</span><span class="p">()</span></div>

<div class="viewcode-block" id="Hamiltonian._sort_output_energies"><a class="viewcode-back" href="../hamiltonian.Hamiltonian.html#hamiltonian.Hamiltonian._sort_output_energies">[docs]</a>    <span class="k">def</span> <span class="nf">_sort_output_energies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="p">[]):</span>

        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">out_data</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">cols</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">lexsort</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">out</span><span class="p">))]</span></div>

<div class="viewcode-block" id="Hamiltonian.sort_output_energies"><a class="viewcode-back" href="../hamiltonian.Hamiltonian.html#hamiltonian.Hamiltonian.sort_output_energies">[docs]</a>    <span class="k">def</span> <span class="nf">sort_output_energies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="p">[]):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sort_output</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_output_data</span><span class="p">()</span></div>

<div class="viewcode-block" id="Hamiltonian.get_predicted_data"><a class="viewcode-back" href="../hamiltonian.Hamiltonian.html#hamiltonian.Hamiltonian.get_predicted_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_predicted_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the complete list of computed energy levels</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">            calc_data: numpy.ndarray</span>
<span class="sd">                The computed energy levels</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_data</span></div>

<div class="viewcode-block" id="Hamiltonian.get_output_data"><a class="viewcode-back" href="../hamiltonian.Hamiltonian.html#hamiltonian.Hamiltonian.get_output_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_output_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_data</span></div>

<div class="viewcode-block" id="Hamiltonian.get_hamiltonian"><a class="viewcode-back" href="../hamiltonian.Hamiltonian.html#hamiltonian.Hamiltonian.get_hamiltonian">[docs]</a>    <span class="k">def</span> <span class="nf">get_hamiltonian</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the Hamiltonian matrix for the last computed J, symmetry</span>
<span class="sd">        and isotopologue</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">            hamiltonian : numpy.ndarray</span>
<span class="sd">                The computed Hamiltonian matrix</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># will get the matrix for the last comupted J, e/f-level and isotope</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian</span></div></div>


<div class="viewcode-block" id="KineticEnergy"><a class="viewcode-back" href="../hamiltonian.KineticEnergy.html#hamiltonian.KineticEnergy">[docs]</a><span class="k">class</span> <span class="nc">KineticEnergy</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate the kinetic energy operator</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">H</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rmin</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">rmin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rmax</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">rmax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">ngrid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nch</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">nch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver_method</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">solver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masses</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">masses</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Fy</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">Fy</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">H</span><span class="o">.</span><span class="n">msize</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">msize</span><span class="p">))</span>

<div class="viewcode-block" id="KineticEnergy.calculate_kinetic_energy"><a class="viewcode-back" href="../hamiltonian.KineticEnergy.html#hamiltonian.KineticEnergy.calculate_kinetic_energy">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_kinetic_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iso</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calls a specific function for the calculation of the kinetic energy</span>
<span class="sd">        depending on the solver method</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            iso : int</span>
<span class="sd">                Isotopologue number</span>

<span class="sd">        Raises</span>
<span class="sd">        ----------</span>
<span class="sd">            ValueError:</span>
<span class="sd">                If the name of the solver method is not correct,</span>
<span class="sd">                an error occurrs</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">            T : numpy.ndarray</span>
<span class="sd">                The calculated matrix of the kinetic energy</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">masses</span><span class="p">[</span><span class="n">iso</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;sinc&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_kinetic_energy_sinc</span><span class="p">(</span><span class="n">mass</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;fourier&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_kinetic_energy_fourier</span><span class="p">(</span><span class="n">mass</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;fd5&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_kinetic_energy_FD5</span><span class="p">(</span><span class="n">mass</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">solver_method</span><span class="si">}</span><span class="s1"> is not allowed solver method...&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="KineticEnergy._calculate_kinetic_energy_fourier"><a class="viewcode-back" href="../hamiltonian.KineticEnergy.html#hamiltonian.KineticEnergy._calculate_kinetic_energy_fourier">[docs]</a>    <span class="k">def</span> <span class="nf">_calculate_kinetic_energy_fourier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate the kinetic energy operator using the Fourir basis</span>

<span class="sd">        Args:</span>
<span class="sd">            mass (double): The mass value</span>

<span class="sd">        Returns:</span>
<span class="sd">            array: The computed kinetic energy matrix</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmax</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmin</span>
        <span class="n">n2</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">6.0</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">h</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">pc</span>
        <span class="n">ml</span> <span class="o">=</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">mass</span> <span class="o">*</span> <span class="n">length</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">h2</span> <span class="o">=</span> <span class="n">h</span><span class="o">**</span><span class="mi">2</span>

        <span class="n">ij_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">]</span>
        <span class="n">ij_mtx</span> <span class="o">=</span> <span class="n">ij_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">ij_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># TODO: check this</span>
        <span class="n">di</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">)</span>
        <span class="n">sinf_mtx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="n">ij_mtx</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">)</span>

        <span class="c1"># set diagonal to some temporary nonzero value</span>
        <span class="n">sinf_mtx</span><span class="p">[</span><span class="n">di</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">]</span> <span class="o">=</span> \
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">ij_mtx</span><span class="p">)</span> <span class="o">*</span> <span class="n">h2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ml</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">sinf_mtx</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">di</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">h2</span> <span class="o">/</span> <span class="n">ml</span><span class="p">)</span> <span class="o">*</span> <span class="n">n2</span>

        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nch</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">ind1</span> <span class="o">=</span> <span class="p">(</span><span class="n">ch</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span>
            <span class="n">ind2</span> <span class="o">=</span> <span class="n">ch</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">ind1</span><span class="p">:</span><span class="n">ind2</span><span class="p">,</span> <span class="n">ind1</span><span class="p">:</span><span class="n">ind2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span></div>

<div class="viewcode-block" id="KineticEnergy._calculate_kinetic_energy_sinc"><a class="viewcode-back" href="../hamiltonian.KineticEnergy.html#hamiltonian.KineticEnergy._calculate_kinetic_energy_sinc">[docs]</a>    <span class="k">def</span> <span class="nf">_calculate_kinetic_energy_sinc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate the kinetic energy operator using the sinc basis</span>

<span class="sd">        Args:</span>
<span class="sd">            mass (double): The mass value</span>

<span class="sd">        Returns:</span>
<span class="sd">            array: The computed kinetic energy matrix</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">pc</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">pi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rmax</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">h2</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">mass</span><span class="p">)</span>

        <span class="n">ij_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">]</span>
        <span class="n">ij_diff</span> <span class="o">=</span> <span class="n">ij_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">ij_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ij_sum</span> <span class="o">=</span> <span class="n">ij_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ij_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">di</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">)</span>

        <span class="c1"># set diagonal to some temporary nonzero value</span>
        <span class="n">ij_diff</span><span class="p">[</span><span class="n">di</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">]</span> <span class="o">=</span> \
            <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">ij_sum</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">ij_diff</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">di</span><span class="p">]</span> <span class="o">=</span> <span class="n">pi2</span> <span class="o">/</span> <span class="mf">3.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="p">(</span><span class="n">h2</span> <span class="o">/</span> <span class="n">h</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nch</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">ind3</span> <span class="o">=</span> <span class="p">(</span><span class="n">ch</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span>
            <span class="n">ind4</span> <span class="o">=</span> <span class="n">ch</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">ind3</span><span class="p">:</span><span class="n">ind4</span><span class="p">,</span> <span class="n">ind3</span><span class="p">:</span><span class="n">ind4</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">di</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">di</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">h2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fy</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span></div>

<div class="viewcode-block" id="KineticEnergy._calculate_kinetic_energy_FD5"><a class="viewcode-back" href="../hamiltonian.KineticEnergy.html#hamiltonian.KineticEnergy._calculate_kinetic_energy_FD5">[docs]</a>    <span class="k">def</span> <span class="nf">_calculate_kinetic_energy_FD5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate the kinetic energy operator using the finite difference method</span>

<span class="sd">        Args:</span>
<span class="sd">            mass (double): The mass value</span>

<span class="sd">        Returns:</span>
<span class="sd">            array: The computed kinetic energy matrix</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># the first and last 2 eigenvalues are wrong</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">h2</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">mass</span><span class="p">)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rmax</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">d0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">)</span>
        <span class="n">d0</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mf">5.0</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>

        <span class="n">d1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">d1</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="o">-</span><span class="mf">4.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span>

        <span class="n">d2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">d2</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">12.0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">]</span> <span class="o">=</span> \
            <span class="p">(</span><span class="n">h2</span><span class="o">/</span><span class="p">(</span><span class="n">step</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_five_diagonal_matrix</span><span class="p">(</span><span class="n">d0</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">)</span>

        <span class="n">corner_coef</span> <span class="o">=</span> <span class="mf">29.0</span> <span class="o">/</span> <span class="mf">12.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">corner_coef</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">corner_coef</span>

        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nch</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">ind3</span> <span class="o">=</span> <span class="p">(</span><span class="n">ch</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span>
            <span class="n">ind4</span> <span class="o">=</span> <span class="n">ch</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">ind3</span><span class="p">:</span><span class="n">ind4</span><span class="p">,</span> <span class="n">ind3</span><span class="p">:</span><span class="n">ind4</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span></div>

<div class="viewcode-block" id="KineticEnergy._five_diagonal_matrix"><a class="viewcode-back" href="../hamiltonian.KineticEnergy.html#hamiltonian.KineticEnergy._five_diagonal_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">_five_diagonal_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">k1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">k2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">k3</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">k1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">k2</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="o">-</span><span class="n">k2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">k3</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">-</span><span class="n">k3</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="PotentialEnergy"><a class="viewcode-back" href="../hamiltonian.PotentialEnergy.html#hamiltonian.PotentialEnergy">[docs]</a><span class="k">class</span> <span class="nc">PotentialEnergy</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">H</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nch</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">nch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncp</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">ncp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">ngrid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rgrid</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">rgrid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rgrid2</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">rgrid2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">channels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">couplings</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">couplings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masses</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">masses</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dd</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">dd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Gy2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">Gy</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ugrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">msize</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">H</span><span class="o">.</span><span class="n">msize</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">msize</span><span class="p">))</span>

<div class="viewcode-block" id="PotentialEnergy.calculate_potential_energy"><a class="viewcode-back" href="../hamiltonian.PotentialEnergy.html#hamiltonian.PotentialEnergy.calculate_potential_energy">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_potential_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jrotn</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">iso</span><span class="p">):</span>

        <span class="n">mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">masses</span><span class="p">[</span><span class="n">iso</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">denom</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">mass</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgrid2</span>

        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nch</span><span class="p">):</span>
            <span class="c1"># ctype = self.channels[ch].model</span>
            <span class="n">lam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="o">.</span><span class="n">nlambda</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="o">.</span><span class="n">nsigma</span>
            <span class="n">omega</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="o">.</span><span class="n">omega</span>
            <span class="n">spin</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="o">.</span><span class="n">mult</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">rot_correction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="o">.</span><span class="n">rot_correction</span>

            <span class="n">num</span> <span class="o">=</span> <span class="p">(</span><span class="n">jrotn</span> <span class="o">*</span> <span class="p">(</span><span class="n">jrotn</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">+</span> <span class="n">spin</span> <span class="o">*</span> <span class="p">(</span><span class="n">spin</span><span class="o">+</span><span class="mf">1.0</span><span class="p">))</span> <span class="o">-</span> \
                <span class="p">(</span><span class="n">omega</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">lam</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">rot_correction</span>

            <span class="n">i1</span> <span class="o">=</span> <span class="n">ch</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span>
            <span class="n">i2</span> <span class="o">=</span> <span class="p">(</span><span class="n">ch</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">,</span> <span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">Gy2</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ugrid</span><span class="p">[</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">num</span> <span class="o">/</span> <span class="n">denom</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span></div>

<div class="viewcode-block" id="PotentialEnergy.calculate_channels_on_grid"><a class="viewcode-back" href="../hamiltonian.PotentialEnergy.html#hamiltonian.PotentialEnergy.calculate_channels_on_grid">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_channels_on_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ypar</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nch</span><span class="p">):</span>
            <span class="c1"># built-in python cubic spline function</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;pointwise&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_pointwise_pec_on_grid</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">ypar</span><span class="p">)</span>

            <span class="c1"># custom implementation of cubic spline function</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;cspline&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_cspline_pec_on_grid</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">ypar</span><span class="p">)</span>

            <span class="c1"># Morse potential function</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;morse&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_Morse_pec_on_grid</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">ypar</span><span class="p">)</span>

            <span class="c1"># EMO potential function</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;emo&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_EMO_pec_on_grid</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">ypar</span><span class="p">)</span>

            <span class="c1"># MLR potential function</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;mlr&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_MLR_pec_on_grid</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">ypar</span><span class="p">)</span>

            <span class="c1"># custom (user-specified) potential function</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;custom&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_custom_pec_on_grid</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">ypar</span><span class="p">)</span></div>

<div class="viewcode-block" id="PotentialEnergy._calculate_pointwise_pec_on_grid"><a class="viewcode-back" href="../hamiltonian.PotentialEnergy.html#hamiltonian.PotentialEnergy._calculate_pointwise_pec_on_grid">[docs]</a>    <span class="k">def</span> <span class="nf">_calculate_pointwise_pec_on_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">ypar</span><span class="p">):</span>

        <span class="n">sind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="o">.</span><span class="n">start_index</span>
        <span class="n">eind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="o">.</span><span class="n">end_index</span>
        <span class="n">xpnts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="o">.</span><span class="n">rpoints</span>
        <span class="n">ypnts</span> <span class="o">=</span> <span class="n">ypar</span><span class="p">[</span><span class="n">sind</span><span class="p">:</span><span class="n">eind</span><span class="p">]</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="n">_CubicSpline</span><span class="p">(</span><span class="n">xpnts</span><span class="p">,</span> <span class="n">ypnts</span><span class="p">,</span> <span class="n">bc_type</span><span class="o">=</span><span class="s1">&#39;natural&#39;</span><span class="p">,</span> <span class="n">extrapolate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ugrid</span><span class="p">[</span><span class="n">ch</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">:(</span><span class="n">ch</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">]</span> <span class="o">=</span> <span class="n">cs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rgrid</span><span class="p">)</span></div>

<div class="viewcode-block" id="PotentialEnergy._calculate_cspline_pec_on_grid"><a class="viewcode-back" href="../hamiltonian.PotentialEnergy.html#hamiltonian.PotentialEnergy._calculate_cspline_pec_on_grid">[docs]</a>    <span class="k">def</span> <span class="nf">_calculate_cspline_pec_on_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">ypar</span><span class="p">):</span>

        <span class="n">sind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="o">.</span><span class="n">start_index</span>
        <span class="n">eind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="o">.</span><span class="n">end_index</span>
        <span class="n">xpnts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">R</span>
        <span class="n">npnts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">npnts</span>
        <span class="n">ypnts</span> <span class="o">=</span> <span class="n">ypar</span><span class="p">[</span><span class="n">sind</span><span class="p">:</span><span class="n">eind</span><span class="p">]</span>

        <span class="n">cs</span> <span class="o">=</span> <span class="n">CSpline</span><span class="p">(</span><span class="n">xpnts</span><span class="p">,</span> <span class="n">ypnts</span><span class="p">)</span>
        <span class="n">index1</span><span class="p">,</span> <span class="n">index2</span> <span class="o">=</span> <span class="p">(</span><span class="n">ch</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">,</span> <span class="n">ch</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ugrid</span><span class="p">[</span><span class="n">index1</span><span class="p">:</span><span class="n">index2</span><span class="p">],</span> <span class="n">sk</span> <span class="o">=</span> <span class="n">cs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rgrid</span><span class="p">,</span> <span class="n">return_deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">stp</span><span class="p">,</span> <span class="n">enp</span> <span class="o">=</span> <span class="p">(</span><span class="n">ch</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">npnts</span><span class="p">,</span> <span class="n">ch</span><span class="o">*</span><span class="n">npnts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sk_grid</span><span class="p">[(</span><span class="n">ch</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">:</span><span class="n">ch</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">,</span> <span class="n">stp</span><span class="p">:</span><span class="n">enp</span><span class="p">]</span> <span class="o">=</span> <span class="n">sk</span></div>

<div class="viewcode-block" id="PotentialEnergy._calculate_Morse_pec_on_grid"><a class="viewcode-back" href="../hamiltonian.PotentialEnergy.html#hamiltonian.PotentialEnergy._calculate_Morse_pec_on_grid">[docs]</a>    <span class="k">def</span> <span class="nf">_calculate_Morse_pec_on_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">ypar</span><span class="p">,</span> <span class="n">ci</span><span class="p">):</span>

        <span class="n">ypnts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">U</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ugrid</span><span class="p">[(</span><span class="n">ch</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">:</span><span class="n">ch</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_VMorse</span><span class="p">(</span><span class="n">ypnts</span><span class="p">)</span></div>

<div class="viewcode-block" id="PotentialEnergy._VMorse"><a class="viewcode-back" href="../hamiltonian.PotentialEnergy.html#hamiltonian.PotentialEnergy._VMorse">[docs]</a>    <span class="k">def</span> <span class="nf">_VMorse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>

        <span class="n">Te</span><span class="p">,</span> <span class="n">De</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">re</span> <span class="o">=</span> <span class="n">params</span>
        <span class="k">return</span> <span class="n">Te</span> <span class="o">+</span> <span class="n">De</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rgrid</span><span class="o">-</span><span class="n">re</span><span class="p">))),</span> <span class="mf">2.0</span><span class="p">)</span></div>

<div class="viewcode-block" id="PotentialEnergy._calculate_EMO_pec_on_grid"><a class="viewcode-back" href="../hamiltonian.PotentialEnergy.html#hamiltonian.PotentialEnergy._calculate_EMO_pec_on_grid">[docs]</a>    <span class="k">def</span> <span class="nf">_calculate_EMO_pec_on_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">ypar</span><span class="p">,</span> <span class="n">ci</span><span class="p">):</span>

        <span class="n">ypnts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">U</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ugrid</span><span class="p">[(</span><span class="n">ch</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">:</span><span class="n">ch</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_VEMO</span><span class="p">(</span><span class="n">ypnts</span><span class="p">)</span></div>

<div class="viewcode-block" id="PotentialEnergy._VEMO"><a class="viewcode-back" href="../hamiltonian.PotentialEnergy.html#hamiltonian.PotentialEnergy._VEMO">[docs]</a>    <span class="k">def</span> <span class="nf">_VEMO</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>

        <span class="n">Te</span><span class="p">,</span> <span class="n">De</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">re</span> <span class="o">=</span> <span class="n">params</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">bparams</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">:])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">yr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_emo_power_expression</span><span class="p">(</span><span class="n">re</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>

        <span class="n">bemo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">bparams</span><span class="p">,</span> <span class="n">yr</span><span class="p">)</span>
        <span class="n">pwr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">bemo</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rgrid</span><span class="o">-</span><span class="n">re</span><span class="p">))),</span> <span class="mf">2.0</span><span class="p">)</span>
        <span class="n">vemo</span> <span class="o">=</span> <span class="n">Te</span> <span class="o">+</span> <span class="n">De</span> <span class="o">*</span> <span class="n">pwr</span>

        <span class="k">return</span> <span class="n">vemo</span></div>

<div class="viewcode-block" id="PotentialEnergy._calculate_MLR_pec_on_grid"><a class="viewcode-back" href="../hamiltonian.PotentialEnergy.html#hamiltonian.PotentialEnergy._calculate_MLR_pec_on_grid">[docs]</a>    <span class="k">def</span> <span class="nf">_calculate_MLR_pec_on_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">ypar</span><span class="p">,</span> <span class="n">ci</span><span class="p">):</span>

        <span class="n">ni</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ni</span>
        <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">nb</span>
        <span class="n">nc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">nc</span>
        <span class="n">nd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">nd</span>

        <span class="n">nall</span> <span class="o">=</span> <span class="p">(</span><span class="n">ni</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="n">nc</span><span class="p">,</span> <span class="n">nd</span><span class="p">)</span>

        <span class="n">ypnts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">U</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ugrid</span><span class="p">[(</span><span class="n">ch</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">:</span><span class="n">ch</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_VMLR</span><span class="p">(</span><span class="n">ypnts</span><span class="p">,</span> <span class="n">nall</span><span class="p">)</span></div>

<div class="viewcode-block" id="PotentialEnergy._VMLR"><a class="viewcode-back" href="../hamiltonian.PotentialEnergy.html#hamiltonian.PotentialEnergy._VMLR">[docs]</a>    <span class="k">def</span> <span class="nf">_VMLR</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">nparams</span><span class="p">):</span>

        <span class="n">ni</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="n">nc</span><span class="p">,</span> <span class="n">nd</span> <span class="o">=</span> <span class="n">nparams</span>
        <span class="n">Te</span><span class="p">,</span> <span class="n">De</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">rref</span><span class="p">,</span> <span class="n">re</span><span class="p">,</span> <span class="n">binf</span> <span class="o">=</span> <span class="n">params</span><span class="p">[:</span><span class="n">ni</span><span class="p">]</span>

        <span class="n">bparams</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">ni</span><span class="p">:</span><span class="n">ni</span><span class="o">+</span><span class="n">nb</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">cparams</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">ni</span><span class="o">+</span><span class="n">nb</span><span class="p">:</span><span class="n">ni</span><span class="o">+</span><span class="n">nb</span><span class="o">+</span><span class="n">nc</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dparams</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">ni</span><span class="o">+</span><span class="n">nb</span><span class="o">+</span><span class="n">nc</span><span class="p">:</span><span class="n">ni</span><span class="o">+</span><span class="n">nb</span><span class="o">+</span><span class="n">nc</span><span class="o">+</span><span class="n">nd</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">yrp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_emo_power_expression</span><span class="p">(</span><span class="n">rref</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="n">yrq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_emo_power_expression</span><span class="p">(</span><span class="n">rref</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>

        <span class="n">bmlj</span> <span class="o">=</span> <span class="n">yrp</span> <span class="o">*</span> <span class="n">binf</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">yrp</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">bparams</span><span class="p">,</span> <span class="n">yrq</span><span class="p">)</span>
        <span class="n">ulrr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_long_range_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rgrid</span><span class="p">,</span> <span class="n">cparams</span><span class="p">,</span> <span class="n">dparams</span><span class="p">)</span>
        <span class="n">ulrre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_long_range_function</span><span class="p">(</span><span class="n">re</span><span class="p">,</span> <span class="n">cparams</span><span class="p">,</span> <span class="n">dparams</span><span class="p">)</span>
        <span class="n">ulr</span> <span class="o">=</span> <span class="n">ulrr</span> <span class="o">/</span> <span class="n">ulrre</span>
        <span class="n">vmlj</span> <span class="o">=</span> <span class="n">Te</span> <span class="o">+</span> <span class="n">De</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ulr</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">bmlj</span><span class="p">)</span><span class="o">*</span><span class="n">yrp</span><span class="p">),</span> <span class="mf">2.0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">vmlj</span></div>

<div class="viewcode-block" id="PotentialEnergy.calculate_emo_power_expression"><a class="viewcode-back" href="../hamiltonian.PotentialEnergy.html#hamiltonian.PotentialEnergy.calculate_emo_power_expression">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_emo_power_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rr</span><span class="p">,</span> <span class="n">power</span><span class="p">):</span>

        <span class="n">numer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rgrid</span><span class="p">,</span> <span class="n">power</span><span class="p">)</span> <span class="o">-</span> <span class="n">rr</span><span class="o">**</span><span class="n">power</span>
        <span class="n">denom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rgrid</span><span class="p">,</span> <span class="n">power</span><span class="p">)</span> <span class="o">+</span> <span class="n">rr</span><span class="o">**</span><span class="n">power</span>

        <span class="k">return</span> <span class="n">numer</span> <span class="o">/</span> <span class="n">denom</span></div>

<div class="viewcode-block" id="PotentialEnergy._long_range_function"><a class="viewcode-back" href="../hamiltonian.PotentialEnergy.html#hamiltonian.PotentialEnergy._long_range_function">[docs]</a>    <span class="k">def</span> <span class="nf">_long_range_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">cparams</span><span class="p">,</span> <span class="n">dparams</span><span class="p">):</span>

        <span class="c1"># TODO: rewrite using numpy</span>
        <span class="n">ulr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cparams</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">ulr</span> <span class="o">+=</span> <span class="n">dparams</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cparams</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ulr</span></div>

<div class="viewcode-block" id="PotentialEnergy._calculate_custom_pec_on_grid"><a class="viewcode-back" href="../hamiltonian.PotentialEnergy.html#hamiltonian.PotentialEnergy._calculate_custom_pec_on_grid">[docs]</a>    <span class="k">def</span> <span class="nf">_calculate_custom_pec_on_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">ypar</span><span class="p">,</span> <span class="n">pranges</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>

        <span class="n">ypnts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">U</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ugrid</span><span class="p">[(</span><span class="n">ch</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">:</span><span class="n">ch</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cfunc</span><span class="p">(</span><span class="n">ypnts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgrid</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Interaction"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction">[docs]</a><span class="k">class</span> <span class="nc">Interaction</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">H</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">ngrid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nch</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">nch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncp</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">ncp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">channels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">couplings</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">couplings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rgrid</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">rgrid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rgrid2</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">rgrid2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masses</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">masses</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msize</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">msize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Gy</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">Gy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dd</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">dd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msize</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">msize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">countl</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cp_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">max_rotnj</span> <span class="o">=</span> <span class="mi">200</span>

        <span class="c1"># TODO: the upper limit is not correct</span>
        <span class="k">for</span> <span class="n">cp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncp</span><span class="o">+</span><span class="mi">6</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cp_map</span><span class="p">[</span><span class="n">cp</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">msize</span><span class="p">,</span> <span class="n">max_rotnj</span><span class="p">))</span>

<div class="viewcode-block" id="Interaction.calculate_coupling_matrix"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction.calculate_coupling_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_coupling_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jrotn</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">iso</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">jrotn</span> <span class="o">=</span> <span class="n">jrotn</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">masses</span><span class="p">[</span><span class="n">iso</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">jjrotn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jrotn</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jrotn</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="n">pert_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">msize</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">msize</span><span class="p">)</span>

        <span class="n">interact_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_interaction_keys</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">cp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">couplings</span><span class="p">)):</span>
            <span class="n">cprops</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">couplings</span><span class="p">[</span><span class="n">cp</span><span class="p">]</span><span class="o">.</span><span class="n">interact</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">couplings</span><span class="p">[</span><span class="n">cp</span><span class="p">]</span><span class="o">.</span><span class="n">coupling</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">couplings</span><span class="p">[</span><span class="n">cp</span><span class="p">]</span><span class="o">.</span><span class="n">multiplier</span><span class="p">)</span>

            <span class="n">ycs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fgrid</span><span class="p">[</span><span class="n">cp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">:(</span><span class="n">cp</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">countc</span><span class="p">,</span> <span class="p">(</span><span class="n">inter</span><span class="p">,</span> <span class="n">ctype</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cprops</span><span class="p">):</span>
                <span class="n">ch1</span><span class="p">,</span> <span class="n">ch2</span> <span class="o">=</span> <span class="n">inter</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_quantum_numbers</span><span class="p">(</span><span class="n">ch1</span><span class="p">,</span> <span class="n">ch2</span><span class="p">)</span>
                <span class="n">cfunc</span> <span class="o">=</span> <span class="n">interact_keys</span><span class="p">[</span><span class="n">ctype</span><span class="p">](</span><span class="n">jjrotn</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>  <span class="c1"># Gy2</span>
                <span class="n">row1</span><span class="p">,</span> <span class="n">row2</span> <span class="o">=</span> <span class="p">(</span><span class="n">ch1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">,</span> <span class="n">ch1</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span>
                <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span> <span class="o">=</span> <span class="p">(</span><span class="n">ch2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">,</span> <span class="n">ch2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span>

                <span class="n">pert_matrix</span><span class="p">[</span><span class="n">row1</span><span class="p">:</span><span class="n">row2</span><span class="p">,</span> <span class="n">col1</span><span class="p">:</span><span class="n">col2</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">]</span> <span class="o">+=</span> <span class="n">cfunc</span> <span class="o">*</span> <span class="n">ycs</span>
                <span class="c1"># self.cp_map[cp+countc][row1:row2, self.countl] = cfunc</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">countl</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">pert_matrix</span></div>

<div class="viewcode-block" id="Interaction.get_couplings_on_grid"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction.get_couplings_on_grid">[docs]</a>    <span class="k">def</span> <span class="nf">get_couplings_on_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fgrid</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># * C_hartree</span></div>

<div class="viewcode-block" id="Interaction.calculate_couplings_on_grid"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction.calculate_couplings_on_grid">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_couplings_on_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ypar</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">cp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncp</span><span class="p">):</span>
            <span class="c1"># built-in cubic spline function</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">couplings</span><span class="p">[</span><span class="n">cp</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;pointwise&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_pointwise_coupling_on_grid</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">ypar</span><span class="p">)</span>

            <span class="c1"># custom implementation of cubic spline function</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">couplings</span><span class="p">[</span><span class="n">cp</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;cspline&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_cspline_coupling_on_grid</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">ypar</span><span class="p">)</span>

            <span class="c1"># constant coupling value</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">couplings</span><span class="p">[</span><span class="n">cp</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;constant&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calculate_constant_coupling_on_grid</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">ypar</span><span class="p">)</span>

            <span class="c1"># custom coupling function</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">couplings</span><span class="p">[</span><span class="n">cp</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;custom&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_custom_coupling_on_grid</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">ypar</span><span class="p">)</span></div>

            <span class="c1"># self._countp += self.couplings[cp].npnts</span>

<div class="viewcode-block" id="Interaction._calculate_pointwise_coupling_on_grid"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction._calculate_pointwise_coupling_on_grid">[docs]</a>    <span class="k">def</span> <span class="nf">_calculate_pointwise_coupling_on_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">ypar</span><span class="p">):</span>

        <span class="n">xpnts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">couplings</span><span class="p">[</span><span class="n">cp</span><span class="p">]</span><span class="o">.</span><span class="n">xc</span>
        <span class="n">ypnts</span> <span class="o">=</span> <span class="n">ypar</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">couplings</span><span class="p">[</span><span class="n">cp</span><span class="p">]</span><span class="o">.</span><span class="n">start_index</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">couplings</span><span class="p">[</span><span class="n">cp</span><span class="p">]</span><span class="o">.</span><span class="n">end_index</span><span class="p">]</span>

        <span class="n">cs</span> <span class="o">=</span> <span class="n">_CubicSpline</span><span class="p">(</span><span class="n">xpnts</span><span class="p">,</span> <span class="n">ypnts</span><span class="p">,</span> <span class="n">bc_type</span><span class="o">=</span><span class="s1">&#39;natural&#39;</span><span class="p">,</span> <span class="n">extrapolate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fgrid</span><span class="p">[</span><span class="n">cp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">:(</span><span class="n">cp</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">]</span> <span class="o">=</span> <span class="n">cs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rgrid</span><span class="p">)</span></div>

<div class="viewcode-block" id="Interaction._calculate_cspline_coupling_on_grid"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction._calculate_cspline_coupling_on_grid">[docs]</a>    <span class="k">def</span> <span class="nf">_calculate_cspline_coupling_on_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">ypar</span><span class="p">):</span>

        <span class="n">xpnts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">couplings</span><span class="p">[</span><span class="n">cp</span><span class="p">]</span><span class="o">.</span><span class="n">xc</span>
        <span class="n">ypnts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">couplings</span><span class="p">[</span><span class="n">cp</span><span class="p">]</span><span class="o">.</span><span class="n">yc</span>

        <span class="n">cs</span> <span class="o">=</span> <span class="n">CSpline</span><span class="p">(</span><span class="n">xpnts</span><span class="p">,</span> <span class="n">ypnts</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">cp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">,</span> <span class="p">(</span><span class="n">cp</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fgrid</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">sk</span> <span class="o">=</span> <span class="n">cs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rgrid</span><span class="p">,</span> <span class="n">return_deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

    <span class="c1"># def calculate_coupling_points(self, cp, yrange, ypar):</span>
    <span class="c1">#     yrange[&#39;end&#39;] = yrange[&#39;start&#39;] + self.couplings[cp].npnts</span>
    <span class="c1">#     ypnts = ypar[yrange[&#39;start&#39;]:yrange[&#39;end&#39;]]</span>
    <span class="c1">#     yrange[&#39;start&#39;] += self.couplings[cp].npnts</span>
    <span class="c1">#     return ypnts</span>

<div class="viewcode-block" id="Interaction.calculate_constant_coupling_on_grid"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction.calculate_constant_coupling_on_grid">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_constant_coupling_on_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">ypar</span><span class="p">):</span>
        <span class="c1"># st = Channel.totp_unique</span>
        <span class="c1"># en = st + self.couplings[cp].npnts</span>
        <span class="c1"># ygrid = ypar[st:en]</span>
        <span class="c1"># st += self.couplings[cp].npnts</span>
        <span class="c1"># self.fgrid[cp*self.ngrid:(cp+1)*self.ngrid] = ygrid</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Interaction._calculate_custom_coupling_on_grid"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction._calculate_custom_coupling_on_grid">[docs]</a>    <span class="k">def</span> <span class="nf">_calculate_custom_coupling_on_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">ypar</span><span class="p">):</span>

        <span class="n">ypnts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">couplings</span><span class="p">[</span><span class="n">cp</span><span class="p">]</span><span class="o">.</span><span class="n">yc</span>
        <span class="c1"># self.calculate_coupling_points(cp, yrange, ypar)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fgrid</span><span class="p">[</span><span class="n">cp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">:(</span><span class="n">cp</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrid</span><span class="p">]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">couplings</span><span class="p">[</span><span class="n">cp</span><span class="p">]</span><span class="o">.</span><span class="n">cfunc</span><span class="p">(</span><span class="n">ypnts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgrid</span><span class="p">)</span></div>

<div class="viewcode-block" id="Interaction.get_quantum_numbers"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction.get_quantum_numbers">[docs]</a>    <span class="k">def</span> <span class="nf">get_quantum_numbers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch1</span><span class="p">,</span> <span class="n">ch2</span><span class="p">):</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;lm1&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch1</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">nlambda</span><span class="p">,</span>
            <span class="s1">&#39;sg1&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch1</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">nsigma</span><span class="p">,</span>
            <span class="s1">&#39;om1&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch1</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">omega</span><span class="p">,</span>
            <span class="s1">&#39;lm2&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch2</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">nlambda</span><span class="p">,</span>
            <span class="s1">&#39;sg2&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch2</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">nsigma</span><span class="p">,</span>
            <span class="s1">&#39;om2&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch2</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">omega</span><span class="p">,</span>
            <span class="s1">&#39;s1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch1</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mult</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;s2&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch2</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mult</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="Interaction.define_interaction_keys"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction.define_interaction_keys">[docs]</a>    <span class="k">def</span> <span class="nf">define_interaction_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;spin-orbit&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_orbit_interaction</span><span class="p">,</span>
            <span class="s1">&#39;lj&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lj_interaction</span><span class="p">,</span>
            <span class="s1">&#39;lj_parity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lj_parity_interaction</span><span class="p">,</span>
            <span class="s1">&#39;sj&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sj_interaction</span><span class="p">,</span>
            <span class="s1">&#39;sj_parity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sj_parity_interaction</span><span class="p">,</span>
            <span class="s1">&#39;sl&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_electornic_interaction</span><span class="p">,</span>
            <span class="s1">&#39;lambdadf&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_doubling_f_parity</span><span class="p">,</span>
            <span class="s1">&#39;lambdade&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_doubling_e_parity</span><span class="p">,</span>
            <span class="s1">&#39;lambdad&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_doubling</span><span class="p">,</span>
            <span class="s1">&#39;ndbobc&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">NDBOBC</span><span class="p">,</span>
            <span class="s1">&#39;dbobc&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">DBOBC</span><span class="p">,</span>
            <span class="s1">&#39;spin-rot&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_rotation_interaction</span><span class="p">,</span>
            <span class="s1">&#39;spin-spin&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_spin_interaction</span><span class="p">,</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="Interaction.spin_orbit_interaction"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction.spin_orbit_interaction">[docs]</a>    <span class="k">def</span> <span class="nf">spin_orbit_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jjrotn</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate diagonal and off-diagonal Spin-Orbit matrix element</span>
<span class="sd">            ``&lt;State1| SO |State1&gt;`` = multiplier * A(R)</span>
<span class="sd">            ``&lt;State1| SO |State2&gt;`` = multiplier * alpha(R)</span>

<span class="sd">           with selection rules:</span>

<span class="sd">        Args:</span>
<span class="sd">            jjrotn (float): parameter with value equal to J(J+1)</span>
<span class="sd">            mass (float): the mass value</span>
<span class="sd">            m (float): multiplier for the R-dependent functions</span>
<span class="sd">            par (int): specify e- or f-symmetry</span>
<span class="sd">            args (list): the electronic and rotational quantum numbers</span>

<span class="sd">        Returns:</span>
<span class="sd">            array: the computed matrix elements</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">socoef</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule_SOdiag</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_SOnondiag</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>

        <span class="c1"># return (ycs / C_hartree) * socoef</span>
        <span class="k">return</span> <span class="n">socoef</span></div>

<div class="viewcode-block" id="Interaction.rule_SOdiag"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction.rule_SOdiag">[docs]</a>    <span class="k">def</span> <span class="nf">rule_SOdiag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;lm1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;lm2&#39;</span><span class="p">]</span> <span class="ow">and</span> \
           <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sg1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sg2&#39;</span><span class="p">]</span> <span class="ow">and</span> \
           <span class="n">args</span><span class="p">[</span><span class="s1">&#39;om1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;om2&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Interaction.rule_SOnondiag"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction.rule_SOnondiag">[docs]</a>    <span class="k">def</span> <span class="nf">rule_SOnondiag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;lm1&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;lm2&#39;</span><span class="p">]</span> <span class="ow">or</span> \
           <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sg1&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sg2&#39;</span><span class="p">]</span> <span class="ow">or</span> \
           <span class="n">args</span><span class="p">[</span><span class="s1">&#39;om1&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;om2&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Interaction.lj_interaction"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction.lj_interaction">[docs]</a>    <span class="k">def</span> <span class="nf">lj_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jjrotn</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate the matrix elements of LJ operator which are:</span>
<span class="sd">           ``&lt;State1| LJ |State1&gt;`` =</span>
<span class="sd">           ``&lt;State1| LJ |State2&gt;`` =</span>

<span class="sd">           with selection rules:</span>

<span class="sd">        Args:</span>
<span class="sd">            jjrotn (float): parameter with value equal to J(J+1)</span>
<span class="sd">            mass (float): the mass value</span>
<span class="sd">            m (float): multiplier for the R-dependent functions</span>
<span class="sd">            par (int): specify e- or f-symmetry</span>
<span class="sd">            args (list): the electronic and rotational quantum numbers</span>

<span class="sd">        Returns:</span>
<span class="sd">            array: the computed matrix elements</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">qexpression</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="n">rule_omegaj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_lj_interaction</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="ow">and</span> \
            <span class="n">_sqrt</span><span class="p">(</span><span class="n">jjrotn</span> <span class="o">-</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;om1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;om2&#39;</span><span class="p">]))</span>

        <span class="n">ljcoef</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="n">qexpression</span> <span class="o">*</span> <span class="n">rule_omegaj</span>

        <span class="n">brot</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">mass</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgrid2</span><span class="p">)</span>

        <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

        <span class="k">return</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">brot</span> <span class="o">*</span> <span class="n">ljcoef</span></div>

<div class="viewcode-block" id="Interaction.rule_lj_interaction"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction.rule_lj_interaction">[docs]</a>    <span class="k">def</span> <span class="nf">rule_lj_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>

        <span class="c1"># to check the abs values</span>
        <span class="n">omega_diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;om1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;om2&#39;</span><span class="p">])</span>
        <span class="n">lambda_diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;lm1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;lm2&#39;</span><span class="p">])</span>

        <span class="n">rule_lj</span> <span class="o">=</span> \
            <span class="p">((</span><span class="n">omega_diff</span> <span class="o">==</span> <span class="n">lambda_diff</span><span class="p">)</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">)</span> <span class="ow">or</span> \
            <span class="p">((</span><span class="n">omega_diff</span> <span class="o">==</span> <span class="n">lambda_diff</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="c1"># rule_lj = \</span>
        <span class="c1">#   ((args[&#39;om1&#39;] - args[&#39;om2&#39;]) == \</span>
        <span class="c1">#   (args[&#39;lm1&#39;] - args[&#39;lm2&#39;]) == 1.0) or \</span>
        <span class="c1">#    ((args[&#39;om1&#39;] - args[&#39;om2&#39;]) == \</span>
        <span class="c1">#   (args[&#39;lm1&#39;] - args[&#39;lm2&#39;]) == -1.0)</span>
        <span class="c1"># print(&#39;LJ&#39;, rule_lj)</span>

        <span class="c1"># # to check!!!</span>
        <span class="n">sg1</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sg1&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;om1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sg1&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sg1</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;sg1&#39;</span><span class="p">])</span>

        <span class="n">sg2</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sg2&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;om2&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sg2&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sg2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;sg2&#39;</span><span class="p">])</span>

        <span class="c1"># if args[&#39;sg1&#39;] == args[&#39;sg2&#39;] and \</span>
        <span class="c1"># args[&#39;s1&#39;] == args[&#39;s2&#39;] and rule_lj and \</span>

        <span class="k">if</span> <span class="n">sg1</span> <span class="o">==</span> <span class="n">sg2</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;s2&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">rule_lj</span> <span class="ow">and</span> \
           <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;om1&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jrotn</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;om2&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jrotn</span><span class="o">+</span><span class="mf">1.0</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Interaction.lj_parity_interaction"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction.lj_parity_interaction">[docs]</a>    <span class="k">def</span> <span class="nf">lj_parity_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jjrotn</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>

        <span class="n">qexpression</span> <span class="o">=</span> <span class="n">_sqrt</span><span class="p">(</span><span class="n">jjrotn</span> <span class="o">+</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;om1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;om2&#39;</span><span class="p">])</span>

        <span class="n">ljcoef</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="n">qexpression</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_lj_parity</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

        <span class="n">brot</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">mass</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgrid2</span><span class="p">)</span>

        <span class="n">sign</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># f-parity</span>
        <span class="k">if</span> <span class="n">par</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>  <span class="c1"># e-parity</span>

        <span class="k">return</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">brot</span> <span class="o">*</span> <span class="n">ljcoef</span></div>

<div class="viewcode-block" id="Interaction.rule_lj_parity"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction.rule_lj_parity">[docs]</a>    <span class="k">def</span> <span class="nf">rule_lj_parity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This interaction is allowed only between Sigma-Pi or Sigma-Sigma states</span>
<span class="sd">        with even multiplicity with Lambda &lt;= 1 and abs(Omega) = 0.5</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">rule_even_mult</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sg1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> \
            <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sg2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;lm1&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;lm2&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">and</span> \
           <span class="p">(</span><span class="ow">not</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;lm1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;lm2&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">rule_even_mult</span> <span class="ow">and</span> \
           <span class="n">args</span><span class="p">[</span><span class="s1">&#39;om1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;om2&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Interaction.sj_interaction"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction.sj_interaction">[docs]</a>    <span class="k">def</span> <span class="nf">sj_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jjrotn</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate the matrix elements of SJ operator which are:</span>
<span class="sd">            ``&lt;State1| SJ |State1&gt;`` =</span>
<span class="sd">            ``&lt;State1| SJ |State2&gt;`` =</span>

<span class="sd">           with selection rules:</span>

<span class="sd">        Args:</span>
<span class="sd">            jjrotn (float): parameter with value equal to J(J+1)</span>
<span class="sd">            mass (float): the mass value</span>
<span class="sd">            m (float): multiplier for the R-dependent functions</span>
<span class="sd">            par (int): specify e- or f-symmetry</span>
<span class="sd">            args (list): the electronic and rotational quantum numbers</span>

<span class="sd">        Returns:</span>
<span class="sd">            array: the computed matrix elements</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">qexpression</span> <span class="o">=</span> <span class="n">_sqrt</span><span class="p">(</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sg1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sg2&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># TODO: check this!</span>
        <span class="n">rule_omegaj</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">rule_sj_interaction</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="ow">and</span> \
            <span class="n">_sqrt</span><span class="p">(</span><span class="n">jjrotn</span> <span class="o">-</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;om1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;om2&#39;</span><span class="p">]))</span>

        <span class="n">sjcoef</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="n">qexpression</span> <span class="o">*</span> <span class="n">rule_omegaj</span>

        <span class="n">brot</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">mass</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgrid2</span><span class="p">)</span>

        <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

        <span class="k">return</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">brot</span> <span class="o">*</span> <span class="n">sjcoef</span></div>

<div class="viewcode-block" id="Interaction.rule_sj_interaction"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction.rule_sj_interaction">[docs]</a>    <span class="k">def</span> <span class="nf">rule_sj_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>

        <span class="n">omega_diff</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;om1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;om2&#39;</span><span class="p">]</span>
        <span class="n">sigma_diff</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sg1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sg2&#39;</span><span class="p">]</span>
        <span class="n">rule_sj</span> <span class="o">=</span> \
            <span class="p">(</span><span class="n">omega_diff</span> <span class="o">==</span> <span class="n">sigma_diff</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">)</span> <span class="ow">or</span> \
            <span class="p">(</span><span class="n">omega_diff</span> <span class="o">==</span> <span class="n">sigma_diff</span> <span class="o">==</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;lm1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;lm2&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;s2&#39;</span><span class="p">]</span> <span class="ow">and</span> \
           <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;om1&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jrotn</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;om2&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jrotn</span><span class="o">+</span><span class="mf">1.0</span><span class="p">)</span> <span class="ow">and</span> \
           <span class="n">rule_sj</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Interaction.sj_parity_interaction"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction.sj_parity_interaction">[docs]</a>    <span class="k">def</span> <span class="nf">sj_parity_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jjrotn</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            only between Sigma states</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">qexpression</span> <span class="o">=</span> <span class="n">_sqrt</span><span class="p">(</span><span class="n">jjrotn</span> <span class="o">+</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;om1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;om2&#39;</span><span class="p">])</span>

        <span class="n">sjcoef</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="n">qexpression</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_sj_parity</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

        <span class="n">brot</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">mass</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgrid2</span><span class="p">)</span>

        <span class="n">sign</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># f-parity</span>
        <span class="k">if</span> <span class="n">par</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>  <span class="c1"># e-parity</span>

        <span class="k">return</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">brot</span> <span class="o">*</span> <span class="n">sjcoef</span></div>

<div class="viewcode-block" id="Interaction.rule_sj_parity"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction.rule_sj_parity">[docs]</a>    <span class="k">def</span> <span class="nf">rule_sj_parity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;lm1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;lm2&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;s2&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Interaction.spin_electornic_interaction"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction.spin_electornic_interaction">[docs]</a>    <span class="k">def</span> <span class="nf">spin_electornic_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jjrotn</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate the matrix elements of SL operator which are:</span>
<span class="sd">            ``&lt;State1| SL |State1&gt;`` =</span>
<span class="sd">            ``&lt;State1| SL |State2&gt;`` =</span>

<span class="sd">           with selection rules:</span>

<span class="sd">        Args:</span>
<span class="sd">            jjrotn (float): parameter with value equal to J(J+1)</span>
<span class="sd">            mass (float): the mass value</span>
<span class="sd">            m (float): multiplier for the R-dependent functions</span>
<span class="sd">            par (int): specify e- or f-symmetry</span>
<span class="sd">            args (list): the electronic and rotational quantum numbers</span>

<span class="sd">        Returns:</span>
<span class="sd">            array: the computed matrix elements</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">qexpression</span> <span class="o">=</span> <span class="n">_sqrt</span><span class="p">(</span>
            <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sg1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sg2&#39;</span><span class="p">])</span>

        <span class="n">slcoef</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="n">qexpression</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_spin_electronic</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

        <span class="n">brot</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">mass</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgrid2</span><span class="p">)</span>

        <span class="n">sign</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="k">return</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">brot</span> <span class="o">*</span> <span class="n">slcoef</span></div>

<div class="viewcode-block" id="Interaction.rule_spin_electronic"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction.rule_spin_electronic">[docs]</a>    <span class="k">def</span> <span class="nf">rule_spin_electronic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>

        <span class="n">lambda_diff</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;lm1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;lm2&#39;</span><span class="p">]</span>
        <span class="n">sigma_diff</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sg2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sg1&#39;</span><span class="p">]</span>

        <span class="n">rule_ls</span> <span class="o">=</span> \
            <span class="p">(</span><span class="n">lambda_diff</span> <span class="o">==</span> <span class="n">sigma_diff</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">)</span> <span class="ow">or</span> \
            <span class="p">(</span><span class="n">lambda_diff</span> <span class="o">==</span> <span class="n">sigma_diff</span> <span class="o">==</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;om1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;om2&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;s2&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">rule_ls</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Interaction.lambda_doubling"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction.lambda_doubling">[docs]</a>    <span class="k">def</span> <span class="nf">lambda_doubling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jjrotn</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>

        <span class="n">ldcoef</span> <span class="o">=</span> <span class="n">jjrotn</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">mass</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgrid2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

        <span class="k">return</span> <span class="n">m</span> <span class="o">*</span> <span class="n">ldcoef</span></div>

<div class="viewcode-block" id="Interaction.lambda_doubling_e_parity"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction.lambda_doubling_e_parity">[docs]</a>    <span class="k">def</span> <span class="nf">lambda_doubling_e_parity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jjrotn</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">par</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_doubling</span><span class="p">(</span><span class="n">jjrotn</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rgrid2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="Interaction.lambda_doubling_f_parity"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction.lambda_doubling_f_parity">[docs]</a>    <span class="k">def</span> <span class="nf">lambda_doubling_f_parity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jjrotn</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">par</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_doubling</span><span class="p">(</span><span class="n">jjrotn</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rgrid2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="Interaction.NDBOBC"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction.NDBOBC">[docs]</a>    <span class="k">def</span> <span class="nf">NDBOBC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jjrotn</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>

        <span class="n">bocoef</span> <span class="o">=</span> <span class="n">jjrotn</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">mass</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgrid2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">m</span> <span class="o">*</span> <span class="n">bocoef</span> <span class="o">*</span> <span class="n">C_hartree</span></div>

<div class="viewcode-block" id="Interaction.DBOBC"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction.DBOBC">[docs]</a>    <span class="k">def</span> <span class="nf">DBOBC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jjrotn</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The diagonal BOB correction</span>

<span class="sd">        Args:</span>
<span class="sd">            jjrotn (float): parameter with value equal to J(J+1)</span>
<span class="sd">            mass (float): the mass value</span>
<span class="sd">            m (float): multiplier for the R-dependent functions</span>
<span class="sd">            par (int): specify e- or f-symmetry</span>
<span class="sd">            args (list): the electronic and rotational quantum numbers</span>

<span class="sd">        Returns:</span>
<span class="sd">            array: the computed correction</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># return (1.0 / C_hartree) * m</span>
        <span class="c1"># return m * ((mass - self.masses[0]) / mass)</span>
        <span class="k">return</span> <span class="n">m</span> <span class="o">*</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">masses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">mass</span><span class="p">)</span> <span class="o">/</span> <span class="n">mass</span><span class="p">)</span></div>

<div class="viewcode-block" id="Interaction.spin_rotation_interaction"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction.spin_rotation_interaction">[docs]</a>    <span class="k">def</span> <span class="nf">spin_rotation_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jjrotn</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_spin_rot_diag</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>

            <span class="n">qexpression</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sg1&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;s2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_spin_rot_nondiag</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="n">ss1</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">qexpression</span> <span class="o">=</span> \
                <span class="n">_sqrt</span><span class="p">(</span><span class="n">jjrotn</span> <span class="o">-</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;om1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;om2&#39;</span><span class="p">]))</span> <span class="o">*</span> \
                <span class="n">_sqrt</span><span class="p">(</span><span class="n">ss1</span> <span class="o">-</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sg1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sg2&#39;</span><span class="p">])</span>

        <span class="n">srcoef</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="n">qexpression</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="k">return</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">srcoef</span></div>

<div class="viewcode-block" id="Interaction.rule_spin_rot_diag"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction.rule_spin_rot_diag">[docs]</a>    <span class="k">def</span> <span class="nf">rule_spin_rot_diag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;om1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;om2&#39;</span><span class="p">]</span> <span class="ow">and</span> \
           <span class="n">args</span><span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;s2&#39;</span><span class="p">]</span> <span class="ow">and</span> \
           <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sg1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sg2&#39;</span><span class="p">]</span> <span class="ow">and</span> \
           <span class="n">args</span><span class="p">[</span><span class="s1">&#39;lm1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;lm2&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Interaction.rule_spin_rot_nondiag"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction.rule_spin_rot_nondiag">[docs]</a>    <span class="k">def</span> <span class="nf">rule_spin_rot_nondiag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rule_sj_interaction</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></div>

<div class="viewcode-block" id="Interaction.spin_spin_interaction"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction.spin_spin_interaction">[docs]</a>    <span class="k">def</span> <span class="nf">spin_spin_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jjrotn</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_spin_spin_diag</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="n">qexpression</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sg1&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;s2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_spin_spin_nondiag</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="n">qexpression</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="n">sscoef</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="n">qexpression</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="k">return</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">sscoef</span></div>

<div class="viewcode-block" id="Interaction.rule_spin_spin_nondiag"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction.rule_spin_spin_nondiag">[docs]</a>    <span class="k">def</span> <span class="nf">rule_spin_spin_nondiag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>

        <span class="n">lambda_diff</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;lm1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;lm2&#39;</span><span class="p">]</span>
        <span class="n">sigma_diff</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sg2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sg1&#39;</span><span class="p">]</span>

        <span class="c1"># Delta Sigma = +/- 1</span>
        <span class="n">rule_ss1_1so</span> <span class="o">=</span> \
            <span class="p">(</span><span class="n">lambda_diff</span> <span class="o">==</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">sigma_diff</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">)</span> <span class="ow">or</span> \
            <span class="p">(</span><span class="n">lambda_diff</span> <span class="o">==</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">sigma_diff</span> <span class="o">==</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="c1"># Delta Sigma = +/- 2</span>
        <span class="n">rule_ss2_2so</span> <span class="o">=</span> \
            <span class="p">(</span><span class="n">lambda_diff</span> <span class="o">==</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">sigma_diff</span> <span class="o">==</span> <span class="mf">2.0</span><span class="p">)</span> <span class="ow">or</span> \
            <span class="p">(</span><span class="n">lambda_diff</span> <span class="o">==</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">sigma_diff</span> <span class="o">==</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">)</span>

        <span class="n">rule_ss1</span> <span class="o">=</span> \
            <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;s2&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mf">1.0</span> <span class="ow">or</span> \
            <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;s2&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="o">-</span><span class="mf">1.0</span> <span class="ow">and</span> \
            <span class="n">rule_ss1_1so</span>

        <span class="n">rule_ss2</span> <span class="o">=</span> \
            <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;s2&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mf">2.0</span> <span class="ow">or</span> \
            <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;s2&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="o">-</span><span class="mf">2.0</span> <span class="ow">and</span> \
            <span class="n">rule_ss2_2so</span>

        <span class="k">if</span> <span class="n">rule_ss1</span> <span class="ow">or</span> <span class="n">rule_ss2</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Interaction.rule_spin_spin_diag"><a class="viewcode-back" href="../hamiltonian.Interaction.html#hamiltonian.Interaction.rule_spin_spin_diag">[docs]</a>    <span class="k">def</span> <span class="nf">rule_spin_spin_diag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;om1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;om2&#39;</span><span class="p">]</span> <span class="ow">and</span> \
           <span class="n">args</span><span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;s2&#39;</span><span class="p">]</span> <span class="ow">and</span> \
           <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sg1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sg2&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="mi">0</span></div></div>
</pre></div>

              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
              
          </main>
          

      </div>
    </div>
  
    <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
  <footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, ihavalyova.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.0.2.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>